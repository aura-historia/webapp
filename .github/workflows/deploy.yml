name: Deploy

on:
    pull_request:
        branches:
            - 'dev'
#  push:
#    branches:
#      - main
#      - dev

permissions:
    contents: read
    deployments: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

jobs:
    deploy:
        name: Deploy to Cloudflare
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 10

            -   name: Set up Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '20'
                    cache: 'pnpm'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile

            -   name: Build application
                run: pnpm run build

            -   name: Determine environment
                id: env
                run: |
                    if [ "${{ github.ref }}" == "refs/heads/main" ]; then
                      echo "environment=production" >> $GITHUB_OUTPUT
                      echo "url=https://aura-historia.com" >> $GITHUB_OUTPUT
                    else
                      echo "environment=staging" >> $GITHUB_OUTPUT
                      echo "url=https://stage.aura-historia.com" >> $GITHUB_OUTPUT
                    fi

            -   name: Deploy to Cloudflare Workers
                uses: cloudflare/wrangler-action@v3
                with:
                    apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                    accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                    command: deploy --env ${{ steps.env.outputs.environment }}

            -   name: Create deployment
                uses: chrnorm/deployment-action@v2
                with:
                    token: ${{ secrets.GITHUB_TOKEN }}
                    environment: ${{ steps.env.outputs.environment }}
                    environment-url: ${{ steps.env.outputs.url }}
                    initial-status: success
