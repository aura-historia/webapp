name: Deploy

on:
    pull_request:
        branches:
            - dev
    workflow_run:
        workflows: [ "CI" ]
        branches: [ main, dev ]
        types:
            - completed

permissions:
    contents: read
    deployments: write
    actions: read

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

jobs:
    deploy:
        name: Deploy to Cloudflare
        runs-on: ubuntu-latest
        timeout-minutes: 10
        # Only run if workflow_run succeeded, or if it's a PR to dev
        if: ${{ github.event_name == 'pull_request' || github.event.workflow_run.conclusion == 'success' }}
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4
                with:
                    ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.event.workflow_run.head_branch }}

            -   name: Set up pnpm
                uses: pnpm/action-setup@v4
                with:
                    version: 10

            -   name: Set up Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '20'
                    cache: 'pnpm'

            -   name: Install dependencies
                run: pnpm install --frozen-lockfile

            -   name: Build application
                run: pnpm run build

            -   name: Determine environment
                id: env
                run: |
                    if [ "${{ github.event_name }}" == "pull_request" ]; then
                      # PR to dev - deploy to staging for testing
                      echo "environment=staging" >> $GITHUB_OUTPUT
                      echo "url=https://stage.aura-historia.com" >> $GITHUB_OUTPUT
                    elif [ "${{ github.event.workflow_run.head_branch }}" == "main" ]; then
                      echo "environment=production" >> $GITHUB_OUTPUT
                      echo "url=https://aura-historia.com" >> $GITHUB_OUTPUT
                    else
                      echo "environment=staging" >> $GITHUB_OUTPUT
                      echo "url=https://stage.aura-historia.com" >> $GITHUB_OUTPUT
                    fi

            -   name: Deploy to Cloudflare Workers
                uses: cloudflare/wrangler-action@v3
                with:
                    apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                    accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                    command: deploy --env ${{ steps.env.outputs.environment }}

            -   name: Create deployment
                uses: chrnorm/deployment-action@v2
                with:
                    token: ${{ secrets.GITHUB_TOKEN }}
                    environment: ${{ steps.env.outputs.environment }}
                    environment-url: ${{ steps.env.outputs.url }}
                    initial-status: success
